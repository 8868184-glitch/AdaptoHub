<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Level Geometry & Topography | AdaptoHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="app.js"></script>`n    <script defer src="time-tracker.js"></script>`n    <script defer src="proficiency-tracker.js"></script>
    <script defer src="dark-mode.js"></script>
    <script defer src="celebrations.js"></script>
    <script defer src="avatar-system.js"></script>
    <script defer src="quiz-animations.js"></script>
    <script defer src="smooth-animations.js"></script>
    <script defer src="loading-tips.js"></script>
    <script defer src="loading-tips-integration.js"></script>
    <script defer src="feature-integration.js"></script>
    <script defer src="achievements.js"></script>
    <script defer src="gamification.js"></script>
    <script defer src="gamification-quiz-integration.js"></script>
    <script defer src="background-customizer.js"></script>
    <style>
        body { margin: 0; background: #f4f7fb; font-family: 'Bai Jamjuree', sans-serif; color: #0f1724; }
        .shell { max-width: 1200px; margin: 100px auto 60px; padding: 0 24px; }
        .hero-card { background: linear-gradient(135deg, #0f172a 0%, #0f4c75 55%, #3282b8 100%); color: #ffffff; border-radius: 16px; padding: 32px; box-shadow: 0 20px 40px rgba(15, 76, 117, 0.25); position: relative; overflow: hidden; }
        .hero-card::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.14), transparent 35%), radial-gradient(circle at 80% 10%, rgba(255,255,255,0.16), transparent 28%), radial-gradient(circle at 60% 70%, rgba(255,255,255,0.12), transparent 32%); pointer-events: none; }
        .hero-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: center; }
        .hero-title { margin: 0 0 10px; font-size: 2rem; letter-spacing: -0.02em; }
        .hero-subtitle { margin: 0; font-size: 1.05rem; color: #e3f2fd; }
        .tag-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
        .pill { padding: 8px 12px; border-radius: 999px; background: rgba(255,255,255,0.16); color: #e3f2fd; font-weight: 600; font-size: 0.9rem; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .summary-card { background: rgba(255,255,255,0.12); border-radius: 12px; padding: 14px; border: 1px solid rgba(255,255,255,0.18); box-shadow: inset 0 1px 0 rgba(255,255,255,0.25); }
        .summary-card span { display: block; color: #c8e6ff; font-size: 0.85rem; }
        .summary-card strong { font-size: 1.3rem; color: #ffffff; }
        .progress-wrap { margin-top: 16px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; color: #c8e6ff; margin-bottom: 6px; }
        .progress-bar { width: 100%; height: 10px; background: rgba(255,255,255,0.18); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #9ae6b4 0%, #38b2ac 100%); width: 0%; transition: width 0.25s ease; }
        .unit-grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 28px; }
        .unit-card { background: #ffffff; border-radius: 14px; padding: 22px; box-shadow: 0 12px 30px rgba(0,0,0,0.05); border: 1px solid #e7edf3; position: relative; overflow: hidden; }
        .unit-header { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .unit-label { display: inline-flex; align-items: center; gap: 8px; background: #e3f2fd; color: #0f4c75; padding: 8px 12px; border-radius: 10px; font-weight: 700; }
        .unit-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; }
        .status-done { background: #e7f6ec; color: #166534; }
        .status-pending { background: #fff4e5; color: #a15c04; }
        .status-locked { background: #ffe4e6; color: #b42318; }
        .unit-title { margin: 6px 0 10px; font-size: 1.35rem; letter-spacing: -0.01em; color: #0f1724; }
        .unit-desc { margin: 0 0 12px; color: #4b5563; line-height: 1.55; }
        .lesson-points { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 8px; margin: 12px 0 6px; }
        .lesson-point { padding: 10px 12px; background: #f4f7fb; border-radius: 10px; border: 1px solid #e7edf3; font-size: 0.95rem; color: #111827; }
        .formula-badges { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 14px; }
        .formula-badge { background: #0f4c75; color: #e3f2fd; padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; }
        .quiz-block { margin-top: 12px; padding: 14px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 12px; }
        .quiz-title { margin: 0 0 8px; font-size: 1rem; color: #0f1724; }
        .quiz-option { display: flex; gap: 10px; align-items: flex-start; padding: 9px 10px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: border 0.2s ease, transform 0.2s ease; }
        .quiz-option:hover { border-color: #0f4c75; transform: translateY(-1px); }
        .quiz-option input { margin-top: 3px; }
        .quiz-actions { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        .primary-btn { background: #0f4c75; color: #ffffff; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .primary-btn:hover { background: #0b3a5a; transform: translateY(-1px); }
        .primary-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .secondary-btn { background: #f0f0f0; color: #0f4c75; border: 1px solid #d0d0d0; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .secondary-btn:hover { background: #e0e0e0; transform: translateY(-1px); }
        .danger-btn { background: #b42318; color: #ffffff; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .danger-btn:hover { background: #922118; transform: translateY(-1px); }
        .reset-section { margin-top: 28px; text-align: center; padding: 20px; background: #fff5f5; border-radius: 14px; border: 1px solid #ffe4e6; }
        .reset-section p { margin: 0 0 12px; color: #4b5563; }
        .ghost-link { display: inline-flex; align-items: center; gap: 8px; color: #0f4c75; font-weight: 700; text-decoration: none; padding: 8px 12px; border: 1px solid #bfdbfe; border-radius: 10px; background: #e3f2fd; }
        .quiz-result { font-weight: 700; font-size: 0.95rem; }
        .result-pass { color: #166534; }
        .result-fail { color: #b42318; }
        .locked-note { color: #b42318; font-weight: 700; margin: 6px 0 0; }
        .top-nav { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .top-nav a { text-decoration: none; }
        @media (max-width: 900px) { .hero-grid { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .unit-card { padding: 18px; } .hero-title { font-size: 1.6rem; } }

        [data-theme="dark"] body {
            background: #1a1d23;
            color: #e6ebf1;
        }
        [data-theme="dark"] .shell {
            background: transparent;
        }
        [data-theme="dark"] .unit-card {
            background: #242830;
            border-color: #3a4150;
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }
        [data-theme="dark"] .unit-title {
            color: #e6ebf1;
        }
        [data-theme="dark"] .unit-desc {
            color: #b8c5d6;
        }
        [data-theme="dark"] .lesson-point {
            background: #2d333e;
            border-color: #3a4150;
            color: #e6ebf1;
        }
        [data-theme="dark"] .quiz-block {
            background: #2d333e;
            border-color: #3a4150;
        }
        [data-theme="dark"] .quiz-title {
            color: #e6ebf1;
        }
        [data-theme="dark"] .quiz-option {
            background: #1a1d23;
            border-color: #3a4150;
        }
        [data-theme="dark"] .quiz-option:hover {
            border-color: #3282b8;
        }
        [data-theme="dark"] .secondary-btn {
            background: #2d333e;
            color: #7dd3fc;
            border-color: #3a4150;
        }
        [data-theme="dark"] .secondary-btn:hover {
            background: #3a4150;
        }
        [data-theme="dark"] .reset-section {
            background: rgba(180, 35, 24, 0.1);
            border-color: rgba(180, 35, 24, 0.3);
        }
        [data-theme="dark"] .reset-section p {
            color: #b8c5d6;
        }
        [data-theme="dark"] .ghost-link {
            background: rgba(50, 130, 184, 0.1);
            border-color: #0f4c75;
            color: #7dd3fc;
        }
    </style>
</head>
<body>
    <header class="top-banner">
        <div class="logo">
            <img height="45" src="assets/AdaptoHub.png" alt="AdaptoHub Logo" />
            <a class="site-title" href="index.html">AdaptoHub</a>
        </div>
        <div class="account-display" id="accountDisplayBtn" style="cursor: pointer; position: relative;">
      <span class="account-name" id="accountName">ชญฏ ชลประเสริฐสุข</span>
      <div class="account-avatar" id="accountAvatar"></div>
      
      <div id="accountDetailsDropdown" class="account-details-dropdown" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #e4e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #1f2933; font-size: 1rem;">Account Information</h3>
          <button onclick="document.getElementById('accountDetailsDropdown').style.display = 'none'; return false;" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #636d79; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#1f2933'" onmouseout="this.style.color='#636d79'">âœ•</button>
        </div>
        <div style="padding: 16px;">
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Full Name</div>
            <div id="detailsDropdownName" style="color: #1f2933; font-weight: 500; font-size: 0.95rem;">ชญฏ ชลประเสริฐสุข</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Email Address</div>
            <div class="user-email" id="dropdownUserEmail">8868184@student.triamudom.ac.th</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Student ID</div>
            <div id="detailsDropdownStudentId" style="color: #1f2933; font-weight: 500; font-size: 0.95rem;">รหัสนักเรียน: 68184 | ห้อง: 665 | เลขที่: 23 | ระดับชั้น: ม.4 | โรงเรียนเตรียมอุดมศึกษา</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Authentication Provider</div>
            <div id="detailsDropdownProvider" style="color: #1f2933; font-weight: 500; font-size: 0.95rem;">magic-link</div>
          </div>
          <div style="margin-bottom: 0;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Login Date & Time</div>
            $17/2/2569 17:27:10</div>
          </div>
        </div>
      </div>
      
      <div id="profileSettingsDropdown" class="account-details-dropdown" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #e4e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #1f2933; font-size: 1rem;">Profile Settings</h3>
          <button onclick="document.getElementById('profileSettingsDropdown').style.display = 'none'; return false;" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #636d79; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#1f2933'" onmouseout="this.style.color='#636d79'">âœ•</button>
        </div>
        <div style="padding: 16px;">
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Display Name</label>
            <input type="text" id="settingsDisplayName" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95rem; color: #1f2933;" placeholder="Your display name">
          </div>
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Email Notifications</label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="settingsEmailNotif" style="margin-right: 8px; cursor: pointer;">
              <span style="font-size: 0.9rem; color: #1f2933;">Receive email notifications</span>
            </label>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Theme Preference</label>
            <select id="settingsTheme" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95rem; color: #1f2933; cursor: pointer;">
              <option value="light">Light Mode</option>
              <option value="dark">Dark Mode</option>
              <option value="auto">Auto (System)</option>
            </select>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Language</label>
            <select id="settingsLanguage" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95rem; color: #1f2933; cursor: pointer;">
              <option value="en">English</option>
              <option value="es">EspaÃ±ol</option>
              <option value="fr">FranÃ§ais</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
          <div style="margin-bottom: 0;">
            <button onclick="saveProfileSettings()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0097b2 0%, #00b8d4 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Save Settings</button>
          </div>
        </div>
      </div>
      
      <div id="learningHistoryDropdown" class="account-details-dropdown" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #e4e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #1f2933; font-size: 1rem;">Learning History</h3>
          <button onclick="document.getElementById('learningHistoryDropdown').style.display = 'none'; return false;" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #636d79; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#1f2933'" onmouseout="this.style.color='#636d79'">âœ•</button>
        </div>
        <div style="padding: 16px; max-height: 400px; overflow-y: auto;">
          <div style="margin-bottom: 12px; padding: 12px; background: #f5f6f8; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: 600; color: #1f2933; font-size: 0.9rem;" id="learningHistoryStats">No activity recorded</div>
            </div>
            <div id="learningHistoryList" style="font-size: 0.85rem; color: #636d79;">
              <p style="margin: 0; text-align: center; padding: 20px 0; color: #8b92a9;">Start taking quizzes and challenges to build your learning history</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="accountDropdownMenu" class="account-dropdown-menu" style="display: none;">
      <div class="account-dropdown-header">
        <div class="user-avatar-large" id="dropdownUserAvatar"></div>
        <div class="user-info">
          <div class="user-name" id="dropdownUserName">ชญฏ ชลประเสริฐสุข</div>
          <div class="user-email" id="dropdownUserEmail">8868184@student.triamudom.ac.th</div>
          <div class="user-id" id="dropdownStudentId">รหัสนักเรียน: 68184</div>
        </div>
      </div>
      <div class="account-dropdown-divider"></div>
      <div class="account-dropdown-body">
        <a href="javascript:void(0);" class="dropdown-item" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => showProfileSettings(), 0); return false;">âš™ï¸ Profile Settings</a>
        <a href="javascript:void(0);" class="dropdown-item" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => showAccountDetailsPanel(), 0); return false;">ðŸ“‹ Account Details</a>
        <a href="javascript:void(0);" class="dropdown-item" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => showLearningHistory(), 0); return false;">ðŸ“š Learning History</a>
      </div>
      <div class="account-dropdown-divider"></div>
      <div class="account-dropdown-footer">
        <button class="logout-btn" onclick="logout()">🚪 ออกจากระบบทั้งหมด</button>
      </div>
    </div>
        </header>

    <main class="shell">
        <div class="top-nav">
            <a class="ghost-link" href="pure_mathematics.html">← Pure Mathematics</a>
            <a class="ghost-link" href="mathematics.html">← Mathematics</a>
            <span style="color:#4b5563; font-weight:600;">A-Level Geometry & Topography • Lessons + quizzes after every unit</span>
        </div>

        <section class="hero-card">
            <div class="hero-grid">
                <div>
                    <h1 class="hero-title">A-Level Geometry & Topography</h1>
                    <p class="hero-subtitle">Sequential units with mastery checks across Euclidean geometry, coordinate methods, vectors, transformations, and real-world topography.</p>
                    <div class="tag-row">
                        <span class="pill">Axioms & proofs</span>
                        <span class="pill">Triangles & circles</span>
                        <span class="pill">Coordinate geometry</span>
                        <span class="pill">Vectors & transforms</span>
                        <span class="pill">Topography & maps</span>
                    </div>
                </div>
                <div class="summary-cards">
                    <div class="summary-card">
                        <span>Units Completed</span>
                        <strong id="unitsCompleted">0 / 6</strong>
                    </div>
                    <div class="summary-card">
                        <span>Current Mastery</span>
                        <strong id="averageScore">0%</strong>
                    </div>
                    <div class="summary-card">
                        <span>Streak-Friendly</span>
                        <strong>Quiz every unit</strong>
                    </div>
                </div>
            </div>
            <div class="progress-wrap">
                <div class="progress-label">
                    <span>Path Completion</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="geometryProgressFill"></div>
                </div>
            </div>
        </section>

        <section class="unit-grid" id="unitGrid"></section>

        <section class="reset-section">
            <p style="font-weight: 700; color: #0f1724;">Start Over?</p>
            <p>Reset your progress for the Geometry & Topography pathway.</p>
            <button class="danger-btn" onclick="resetGeometryProgress()">Reset Geometry Progress</button>
        </section>
    </main>

    <script>
        const geometryUnits = [
            {
                id: 'axioms',
                title: 'Foundations: Axioms, Angles, and Proofs',
                description: 'Work with geometric postulates, angle relationships, and formal proof structures.',
                points: [
                    'Parallel line theorems give angle pairs: corresponding, alternate interior, alternate exterior.',
                    'Triangle angle sum is 180 degrees; exterior angle equals sum of remote interior angles.',
                    'Congruence uses SSS, SAS, ASA, AAS, and HL (right triangles).',
                    'Proofs require clear givens, statements, reasons, and justified conclusions.',
                    'Perpendicular lines form four right angles; complementary sum 90, supplementary sum 180.'
                ],
                formulas: [
                    'm∠1 + m∠2 + m∠3 = 180',
                    'Exterior angle = sum of two remote interior angles'
                ],
                quiz: [
                    { id: 'q1', prompt: 'If two lines are cut by a transversal and a pair of alternate interior angles are congruent, the lines are:', options: [ { text: 'Parallel', correct: true }, { text: 'Perpendicular', correct: false }, { text: 'Skew', correct: false } ] },
                    { id: 'q2', prompt: 'Which triangle congruence is valid?', options: [ { text: 'SAS', correct: true }, { text: 'AAA', correct: false }, { text: 'SSA (general)', correct: false } ] },
                    { id: 'q3', prompt: 'An exterior angle of a triangle measures 120 degrees; one remote interior is 50. The other remote interior is:', options: [ { text: '70 degrees', correct: true }, { text: '60 degrees', correct: false }, { text: '50 degrees', correct: false } ] }
                ]
            },
            {
                id: 'triangles-circles',
                title: 'Triangles, Similarity, and Circles',
                description: 'Prove similarity, use right-triangle ratios, and analyze circles, chords, and tangents.',
                points: [
                    'Similarity via AA, SSS~, SAS~; corresponding sides proportional, angles congruent.',
                    'Right triangles use SOH-CAH-TOA; Pythagorean theorem for distance.',
                    'In a circle, inscribed angle = half its intercepted arc; central angle = arc measure.',
                    'Chord properties: congruent chords have congruent arcs; perpendicular bisector passes through center.',
                    'Tangent is perpendicular to radius at point of tangency; tangent segments from a point are congruent.'
                ],
                formulas: [
                    'a^2 + b^2 = c^2',
                    'sin θ = opposite/hypotenuse',
                    'm∠inscribed = 1/2 arc'
                ],
                quiz: [
                    { id: 'q1', prompt: 'If two triangles are similar, their corresponding side ratios are:', options: [ { text: 'Equal', correct: true }, { text: 'Unrelated', correct: false }, { text: 'Equal only for right triangles', correct: false } ] },
                    { id: 'q2', prompt: 'In a right triangle with legs 6 and 8, hypotenuse is:', options: [ { text: '10', correct: true }, { text: '12', correct: false }, { text: '14', correct: false } ] },
                    { id: 'q3', prompt: 'An inscribed angle intercepts a 100 degree arc. The angle measure is:', options: [ { text: '50 degrees', correct: true }, { text: '100 degrees', correct: false }, { text: '25 degrees', correct: false } ] }
                ]
            },
            {
                id: 'coordinate-geometry',
                title: 'Coordinate Geometry and Loci',
                description: 'Use analytic geometry to model lines, distance, midpoint, slopes, and loci conditions.',
                points: [
                    'Distance formula comes from Pythagorean theorem; midpoint averages coordinates.',
                    'Slope measures steepness: rise/run; parallel lines share slope, perpendicular slopes multiply to -1.',
                    'Line forms: slope-intercept y = mx + b, point-slope y - y1 = m(x - x1).',
                    'A locus is the set of points satisfying a condition (e.g., fixed distance is a circle).',
                    'Circle equation (center h, k, radius r): (x - h)^2 + (y - k)^2 = r^2.'
                ],
                formulas: [
                    'd = sqrt((x2 - x1)^2 + (y2 - y1)^2)',
                    'm = (y2 - y1) / (x2 - x1)',
                    '(x - h)^2 + (y - k)^2 = r^2'
                ],
                quiz: [
                    { id: 'q1', prompt: 'Slope of line through (2,3) and (6,7) is:', options: [ { text: '1', correct: true }, { text: '2', correct: false }, { text: '4', correct: false } ] },
                    { id: 'q2', prompt: 'Midpoint of (0,0) and (4,6) is:', options: [ { text: '(2, 3)', correct: true }, { text: '(4, 3)', correct: false }, { text: '(2, 6)', correct: false } ] },
                    { id: 'q3', prompt: 'Equation of circle center (1, -2) radius 5:', options: [ { text: '(x - 1)^2 + (y + 2)^2 = 25', correct: true }, { text: 'x^2 + y^2 = 25', correct: false }, { text: '(x + 1)^2 + (y - 2)^2 = 25', correct: false } ] }
                ]
            },
            {
                id: 'vectors-transformations',
                title: 'Vectors, Transformations, and Matrices',
                description: 'Represent displacement with vectors, perform transformations, and apply basic matrices.',
                points: [
                    'Vector addition is head-to-tail; scalar multiplication scales magnitude.',
                    'Magnitude of vector v = <a, b> is sqrt(a^2 + b^2).',
                    'Transformations: translations, reflections, rotations, dilations; preserve or alter congruence.',
                    'Matrix multiplication can represent successive transformations in the plane.',
                    'Determinant of a 2x2 matrix gives area scale factor and orientation (sign).' 
                ],
                formulas: [
                    '|v| = sqrt(a^2 + b^2)',
                    '[ [a, b], [c, d] ] determinant = ad - bc',
                    'Rotation 90 deg about origin: (x, y) -> (-y, x)'
                ],
                quiz: [
                    { id: 'q1', prompt: 'Magnitude of vector <3,4> is:', options: [ { text: '5', correct: true }, { text: '7', correct: false }, { text: '12', correct: false } ] },
                    { id: 'q2', prompt: 'Reflection over x-axis sends (2, -5) to:', options: [ { text: '(2, 5)', correct: true }, { text: '(-2, -5)', correct: false }, { text: '(-2, 5)', correct: false } ] },
                    { id: 'q3', prompt: 'Determinant of [[2,1],[0,3]] is:', options: [ { text: '6', correct: true }, { text: '5', correct: false }, { text: '3', correct: false } ] }
                ]
            },
            {
                id: 'solids-measure',
                title: 'Solids, Surface Area, and Volume',
                description: 'Analyze prisms, pyramids, cylinders, cones, and spheres with nets, area, and volume.',
                points: [
                    'Surface area uses sum of all faces; nets help visualize each region.',
                    'Volume formulas: prism/cylinder base area times height; pyramid/cone is one third base area times height.',
                    'Sphere surface area 4πr^2; volume 4/3 πr^3.',
                    'Cross-sections of solids produce 2D shapes; parallel vs perpendicular cuts change the section.',
                    'Scale factors: linear k -> area k^2 -> volume k^3.'
                ],
                formulas: [
                    'V_cylinder = πr^2h',
                    'V_cone = 1/3 πr^2h',
                    'V_sphere = 4/3 πr^3'
                ],
                quiz: [
                    { id: 'q1', prompt: 'Volume of a cylinder radius 3 height 10:', options: [ { text: '90π', correct: true }, { text: '30π', correct: false }, { text: '9π', correct: false } ] },
                    { id: 'q2', prompt: 'Surface area scale factor when linear scale doubles:', options: [ { text: '4', correct: true }, { text: '2', correct: false }, { text: '8', correct: false } ] },
                    { id: 'q3', prompt: 'Volume of a sphere radius 2:', options: [ { text: '32/3 π', correct: true }, { text: '16π', correct: false }, { text: '8π', correct: false } ] }
                ]
            },
            {
                id: 'topography',
                title: 'Topography, Maps, and Elevation',
                description: 'Interpret contour maps, gradients, bearings, and apply geometry to terrain modeling.',
                points: [
                    'Contour lines connect equal elevation; close spacing indicates steep slope.',
                    'Gradient (rise/run) relates to slope; topographic profiles show elevation vs distance.',
                    'Bearings use three-digit angles from north, measured clockwise.',
                    'Scale on maps converts distances; 1:25,000 means 1 unit on map equals 25,000 on ground.',
                    'Trig on slopes: elevation change = distance times sin(angle of incline).' 
                ],
                formulas: [
                    'Gradient = rise / run',
                    'Distance_on_ground = distance_on_map × scale',
                    'Elevation change = d sin θ'
                ],
                quiz: [
                    { id: 'q1', prompt: 'Contour lines that are very close together indicate:', options: [ { text: 'Steep slope', correct: true }, { text: 'Flat terrain', correct: false }, { text: 'Sea level', correct: false } ] },
                    { id: 'q2', prompt: 'Bearing of east from north is:', options: [ { text: '090 degrees', correct: true }, { text: '045 degrees', correct: false }, { text: '180 degrees', correct: false } ] },
                    { id: 'q3', prompt: 'On a 1:25,000 map, 4 cm represents:', options: [ { text: '1 km', correct: true }, { text: '100 m', correct: false }, { text: '10 km', correct: false } ] }
                ]
            }
        ];

        const storageKey = 'adaptohub_geometry_units';
        let unitProgress = JSON.parse(localStorage.getItem(storageKey) || '{}');

        function saveProgress() {
            localStorage.setItem(storageKey, JSON.stringify(unitProgress));
        }

        function renderSummary() {
            const completed = geometryUnits.filter(u => unitProgress[u.id]?.completed).length;
            const scores = geometryUnits.map(u => unitProgress[u.id]?.score).filter(s => typeof s === 'number');
            const avg = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const percent = Math.round((completed / geometryUnits.length) * 100);
            document.getElementById('unitsCompleted').textContent = `${completed} / ${geometryUnits.length}`;
            document.getElementById('averageScore').textContent = `${avg}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('geometryProgressFill').style.width = `${percent}%`;
        }

        function formatFormula(formula) {
            return formula
                .replace(/([A-Za-z])_\{([^}]+)\}/g, '$1<sub>$2</sub>')
                .replace(/([A-Za-z])_([A-Za-z0-9]+)/g, '$1<sub>$2</sub>')
                .replace(/\^\{([^}]+)\}/g, '<sup>$1</sup>')
                .replace(/\^([0-9+-]+)/g, '<sup>$1</sup>')
                .replace(/([A-Za-z])([0-9]+)/g, '$1<sub>$2</sub>');
        }

        function retakeUnit(unitId) {
            if (confirm('Retake this unit? Your previous score will be cleared.')) {
                delete unitProgress[unitId];
                saveProgress();
                renderSummary();
                renderUnits();
            }
        }

        function resetGeometryProgress() {
            if (confirm('Reset progress for the Geometry & Topography pathway? This cannot be undone.')) {
                unitProgress = {};
                saveProgress();
                renderSummary();
                renderUnits();
                alert('Geometry progress has been reset.');
            }
        }

        function renderUnits() {
            const grid = document.getElementById('unitGrid');
            grid.innerHTML = '';
            geometryUnits.forEach((unit, index) => {
                const prevUnit = geometryUnits[index - 1];
                const locked = index > 0 && !(unitProgress[prevUnit?.id]?.completed);
                const progress = unitProgress[unit.id] || {};
                const statusClass = locked ? 'status-locked' : progress.completed ? 'status-done' : 'status-pending';
                const statusText = locked ? 'Complete the previous unit first' : progress.completed ? `Completed - ${progress.score}%` : 'Quiz ready';
                const lessonList = unit.points.map(p => `<div class="lesson-point">${formatFormula(p)}</div>`).join('');
                const formulaList = unit.formulas.map(f => `<span class="formula-badge">${formatFormula(f)}</span>`).join('');
                const questionsHtml = unit.quiz.map(q => `<div class="quiz-question" style="margin-bottom:10px;"><p class="quiz-title">${formatFormula(q.prompt)}</p>${q.options.map((opt) => `<label class="quiz-option"><input type="radio" name="${unit.id}-${q.id}" value="${opt.correct ? 'correct' : 'wrong'}" ${locked ? 'disabled' : ''}><span>${formatFormula(opt.text)}</span></label>`).join('')}</div>`).join('');
                const actionButtons = progress.completed ? `<button class="secondary-btn" onclick="retakeUnit('${unit.id}')">Retake Unit</button><span class="quiz-result" id="result-${unit.id}" style="margin-left: 10px;"></span>` : `<button class="primary-btn" onclick="submitQuiz('${unit.id}')" ${locked ? 'disabled' : ''}>Submit quiz</button><span class="quiz-result" id="result-${unit.id}"></span>`;
                const card = document.createElement('article');
                card.className = `unit-card ${locked ? 'locked' : ''}`;
                card.innerHTML = `<div class="unit-header"><div class="unit-label">Unit ${index + 1}</div><div class="unit-status ${statusClass}">${statusText}</div></div><h3 class="unit-title">${unit.title}</h3><p class="unit-desc">${unit.description}</p><div class="lesson-points">${lessonList}</div><div class="formula-badges">${formulaList}</div><div class="quiz-block" data-quiz="${unit.id}"><p style="margin:0 0 6px; font-weight:700; color:#0f1724;">Quick mastery quiz (3 questions)</p>${locked ? `<p class="locked-note">Unlock by completing Unit ${index}</p>` : ''} ${questionsHtml}<div class="quiz-actions">${actionButtons}</div></div>`;
                grid.appendChild(card);
            });
        }

        function submitQuiz(unitId) {
            const unit = geometryUnits.find(u => u.id === unitId);
            if (!unit) return;
            if (unitProgress[unitId]?.completed) {
                alert('This unit has already been submitted. Use Retake Unit to try again.');
                return;
            }
            const quizBlock = document.querySelector(`[data-quiz="${unitId}"]`);
            if (!quizBlock) return;
            let answered = 0, correct = 0;
            unit.quiz.forEach(q => {
                const selected = quizBlock.querySelector(`input[name="${unit.id}-${q.id}"]:checked`);
                if (selected) {
                    answered++;
                    if (selected.value === 'correct') correct++;
                }
            });
            if (answered !== unit.quiz.length) {
                alert('Please answer every question before submitting.');
                return;
            }
            const score = Math.round((correct / unit.quiz.length) * 100);
            unitProgress[unitId] = { completed: true, score, timestamp: Date.now(), completedDate: new Date().toISOString() };
            saveProgress();
            renderSummary();
            renderUnits();
            const resultEl = document.getElementById(`result-${unitId}`);
            if (resultEl) {
                resultEl.textContent = score >= 70 ? `Great work: ${score}%` : `Keep reviewing: ${score}%`;
                resultEl.className = `quiz-result ${score >= 70 ? 'result-pass' : 'result-fail'}`;
            }

            if (window.FeatureIntegration && window.FeatureIntegration.onQuizComplete) {
                window.FeatureIntegration.onQuizComplete(unitId, score, 'geometry');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeUser();
            renderSummary();
            renderUnits();
        });
    </script>
</body>
</html>
