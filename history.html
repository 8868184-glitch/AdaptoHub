<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History | AdaptoHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="app.js"></script>`n    <script defer src="time-tracker.js"></script>`n    <script defer src="proficiency-tracker.js"></script>
    <script defer src="dark-mode.js"></script>
    <script defer src="celebrations.js"></script>
    <script defer src="avatar-system.js"></script>
    <script defer src="quiz-animations.js"></script>
    <script defer src="smooth-animations.js"></script>
    <script defer src="loading-tips.js"></script>
    <script defer src="loading-tips-integration.js"></script>
    <script defer src="feature-integration.js"></script>
    <style>
        body { margin: 0; background: #fff8f0; font-family: 'Bai Jamjuree', sans-serif; color: #23160f; }
        .history-shell { max-width: 1200px; margin: 100px auto 60px; padding: 0 24px; }
        .hero-card { background: linear-gradient(135deg, #8c3b00 0%, #c86a24 55%, #ffb16d 100%); color: #fff6ed; border-radius: 16px; padding: 32px; box-shadow: 0 20px 40px rgba(140, 59, 0, 0.25); position: relative; overflow: hidden; }
        .hero-card::after { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.14), transparent 35%), radial-gradient(circle at 80% 10%, rgba(255,255,255,0.16), transparent 28%), radial-gradient(circle at 60% 70%, rgba(255,255,255,0.12), transparent 32%); pointer-events: none; }
        .hero-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: center; }
        .hero-title { margin: 0 0 10px; font-size: 2rem; letter-spacing: -0.02em; }
        .hero-subtitle { margin: 0; font-size: 1.05rem; color: #ffeada; }
        .tag-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
        .pill { padding: 8px 12px; border-radius: 999px; background: rgba(255,255,255,0.16); color: #fff6ed; font-weight: 600; font-size: 0.9rem; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .summary-card { background: rgba(255,255,255,0.14); border-radius: 12px; padding: 14px; border: 1px solid rgba(255,255,255,0.2); box-shadow: inset 0 1px 0 rgba(255,255,255,0.25); }
        .summary-card span { display: block; color: #ffe8d8; font-size: 0.85rem; }
        .summary-card strong { font-size: 1.3rem; color: #ffffff; }
        .progress-wrap { margin-top: 16px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; color: #ffe8d8; margin-bottom: 6px; }
        .progress-bar { width: 100%; height: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ffe0b2 0%, #ffb74d 100%); width: 0%; transition: width 0.25s ease; }
        .unit-grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 28px; }
        .unit-card { background: #ffffff; border-radius: 14px; padding: 22px; box-shadow: 0 12px 30px rgba(0,0,0,0.05); border: 1px solid #f0e1d8; position: relative; overflow: visible; }
        .unit-header { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .unit-label { display: inline-flex; align-items: center; gap: 8px; background: #fff2e5; color: #8c3b00; padding: 8px 12px; border-radius: 10px; font-weight: 700; }
        .unit-status { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; }
        .status-done { background: #e7f6ec; color: #1b5e20; }
        .status-pending { background: #fff4e5; color: #a15c04; }
        .status-locked { background: #ffe4e6; color: #b42318; }
        .unit-title { margin: 6px 0 10px; font-size: 1.35rem; letter-spacing: -0.01em; color: #23160f; }
        .unit-desc { margin: 0 0 12px; color: #4b382e; line-height: 1.55; }
        .lesson-points { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 8px; margin: 12px 0 6px; }
        .lesson-point { padding: 10px 12px; background: #fff7ef; border-radius: 10px; border: 1px solid #f0e1d8; font-size: 0.95rem; color: #2f1e16; }
        .formula-badges { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 14px; }
        .formula-badge { background: #8c3b00; color: #ffe8d8; padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; }
        .quiz-block { margin-top: 12px; padding: 14px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 12px; }
        .quiz-title { margin: 0 0 8px; font-size: 1rem; color: #23160f; }
        .quiz-option { display: flex; gap: 10px; align-items: flex-start; padding: 9px 10px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: border 0.2s ease, transform 0.2s ease; }
        .quiz-option:hover { border-color: #8c3b00; transform: translateY(-1px); }
        .quiz-option input { margin-top: 3px; }
        .quiz-actions { display: flex; gap: 10px; align-items: center; margin-top: 10px; flex-wrap: wrap; }
        .primary-btn { background: #8c3b00; color: #ffffff; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .primary-btn:hover { background: #7a3200; transform: translateY(-1px); }
        .primary-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .secondary-btn { background: #f0f0f0; color: #8c3b00; border: 1px solid #d0d0d0; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .secondary-btn:hover { background: #e0e0e0; transform: translateY(-1px); }
        .danger-btn { background: #b42318; color: #ffffff; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .danger-btn:hover { background: #922118; transform: translateY(-1px); }
        .reset-section { margin-top: 28px; text-align: center; padding: 20px; background: #fff5f5; border-radius: 14px; border: 1px solid #ffe4e6; }
        .reset-section p { margin: 0 0 12px; color: #4b382e; }
        .ghost-link { display: inline-flex; align-items: center; gap: 8px; color: #8c3b00; font-weight: 700; text-decoration: none; padding: 8px 12px; border: 1px solid #f0e1d8; border-radius: 10px; background: #fff7ef; }
        .quiz-result { font-weight: 700; font-size: 0.95rem; }
        .result-pass { color: #1b5e20; }
        .result-fail { color: #b42318; }
        .locked-note { color: #b42318; font-weight: 700; margin: 6px 0 0; }
        .top-nav { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .top-nav a { text-decoration: none; }
        @media (max-width: 900px) { .hero-grid { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .unit-card { padding: 18px; } .hero-title { font-size: 1.6rem; } }
    </style>
    <script defer src="background-customizer.js"></script>
</head>
<body>
    <header class="top-banner">
        <div class="logo">
            <img height="45" src="assets/AdaptoHub.png" alt="AdaptoHub Logo" />
            <a class="site-title" href="index.html">AdaptoHub</a>
        </div>
        <div class="account-display" id="accountDisplayBtn" style="cursor: pointer; position: relative;">
      <span class="account-name" id="accountName">ชญฏ ชลประเสริฐสุข</span>
      <div class="account-avatar" id="accountAvatar"></div>
      
      <div id="accountDetailsDropdown" class="account-details-dropdown" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #e4e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #1f2933; font-size: 1rem;">Account Information</h3>
          <button onclick="document.getElementById('accountDetailsDropdown').style.display = 'none'; return false;" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #636d79; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#1f2933'" onmouseout="this.style.color='#636d79'">âœ•</button>
        </div>
        <div style="padding: 16px;">
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Full Name</div>
            <div id="detailsDropdownName" style="color: #1f2933; font-weight: 500; font-size: 0.95rem;">ชญฏ ชลประเสริฐสุข</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Email Address</div>
            <div class="user-email" id="dropdownUserEmail">8868184@student.triamudom.ac.th</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Student ID</div>
            <div id="detailsDropdownStudentId" style="color: #1f2933; font-weight: 500; font-size: 0.95rem;">รหัสนักเรียน: 68184 | ห้อง: 665 | เลขที่: 23 | ระดับชั้น: ม.4 | โรงเรียนเตรียมอุดมศึกษา</div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Authentication Provider</div>
            <div id="detailsDropdownProvider" style="color: #1f2933; font-weight: 500; font-size: 0.95rem;">magic-link</div>
          </div>
          <div style="margin-bottom: 0;">
            <div style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">Login Date & Time</div>
            $17/2/2569 17:27:10</div>
          </div>
        </div>
      </div>
      
      <div id="profileSettingsDropdown" class="account-details-dropdown" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #e4e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #1f2933; font-size: 1rem;">Profile Settings</h3>
          <button onclick="document.getElementById('profileSettingsDropdown').style.display = 'none'; return false;" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #636d79; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#1f2933'" onmouseout="this.style.color='#636d79'">âœ•</button>
        </div>
        <div style="padding: 16px;">
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Display Name</label>
            <input type="text" id="settingsDisplayName" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95rem; color: #1f2933;" placeholder="Your display name">
          </div>
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Email Notifications</label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" id="settingsEmailNotif" style="margin-right: 8px; cursor: pointer;">
              <span style="font-size: 0.9rem; color: #1f2933;">Receive email notifications</span>
            </label>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Theme Preference</label>
            <select id="settingsTheme" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95rem; color: #1f2933; cursor: pointer;">
              <option value="light">Light Mode</option>
              <option value="dark">Dark Mode</option>
              <option value="auto">Auto (System)</option>
            </select>
          </div>
          <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; color: #8b92a9; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; display: block;">Language</label>
            <select id="settingsLanguage" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 0.95rem; color: #1f2933; cursor: pointer;">
              <option value="en">English</option>
              <option value="es">EspaÃ±ol</option>
              <option value="fr">FranÃ§ais</option>
              <option value="de">Deutsch</option>
            </select>
          </div>
          <div style="margin-bottom: 0;">
            <button onclick="saveProfileSettings()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #0097b2 0%, #00b8d4 100%); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Save Settings</button>
          </div>
        </div>
      </div>
      
      <div id="learningHistoryDropdown" class="account-details-dropdown" style="display: none;">
        <div style="padding: 16px; border-bottom: 1px solid #e4e7eb; display: flex; justify-content: space-between; align-items: center;">
          <h3 style="margin: 0; color: #1f2933; font-size: 1rem;">Learning History</h3>
          <button onclick="document.getElementById('learningHistoryDropdown').style.display = 'none'; return false;" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #636d79; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='#1f2933'" onmouseout="this.style.color='#636d79'">âœ•</button>
        </div>
        <div style="padding: 16px; max-height: 400px; overflow-y: auto;">
          <div style="margin-bottom: 12px; padding: 12px; background: #f5f6f8; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: 600; color: #1f2933; font-size: 0.9rem;" id="learningHistoryStats">No activity recorded</div>
            </div>
            <div id="learningHistoryList" style="font-size: 0.85rem; color: #636d79;">
              <p style="margin: 0; text-align: center; padding: 20px 0; color: #8b92a9;">Start taking quizzes and challenges to build your learning history</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="accountDropdownMenu" class="account-dropdown-menu" style="display: none;">
      <div class="account-dropdown-header">
        <div class="user-avatar-large" id="dropdownUserAvatar"></div>
        <div class="user-info">
          <div class="user-name" id="dropdownUserName">ชญฏ ชลประเสริฐสุข</div>
          <div class="user-email" id="dropdownUserEmail">8868184@student.triamudom.ac.th</div>
          <div class="user-id" id="dropdownStudentId">รหัสนักเรียน: 68184</div>
        </div>
      </div>
      <div class="account-dropdown-divider"></div>
      <div class="account-dropdown-body">
        <a href="javascript:void(0);" class="dropdown-item" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => showProfileSettings(), 0); return false;">âš™ï¸ Profile Settings</a>
        <a href="javascript:void(0);" class="dropdown-item" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => showAccountDetailsPanel(), 0); return false;">ðŸ“‹ Account Details</a>
        <a href="javascript:void(0);" class="dropdown-item" onclick="event.preventDefault(); event.stopPropagation(); setTimeout(() => showLearningHistory(), 0); return false;">ðŸ“š Learning History</a>
      </div>
      <div class="account-dropdown-divider"></div>
      <div class="account-dropdown-footer">
        <button class="logout-btn" onclick="logout()">🚪 ออกจากระบบทั้งหมด</button>
      </div>
    </div>
        </header>

    <main class="history-shell">
        <div class="top-nav">
            <a class="ghost-link" href="social_studies.html">← Back to Social Studies</a>
            <span style="color:#4b382e; font-weight:600;">History - Chronological units with quick mastery quizzes</span>
        </div>

        <section class="hero-card">
            <div class="hero-grid">
                <div>
                    <h1 class="hero-title">Thai History Learning Path</h1>
                    <p class="hero-subtitle">Move chronologically from Sukhothai origins through Ayutthaya, Thonburi/Rattanakosin, modernization reforms, the 1932 revolution, and contemporary governance.</p>
                    <div class="tag-row">
                        <span class="pill">Chronology and continuity</span>
                        <span class="pill">State-building</span>
                        <span class="pill">Modernization reforms</span>
                        <span class="pill">Constitutional change</span>
                    </div>
                </div>
                <div class="summary-cards">
                    <div class="summary-card">
                        <span>Units Completed</span>
                        <strong id="unitsCompleted">0 / 7</strong>
                    </div>
                    <div class="summary-card">
                        <span>Current Mastery</span>
                        <strong id="averageScore">0%</strong>
                    </div>
                    <div class="summary-card">
                        <span>Streak-Friendly</span>
                        <strong>Quiz every unit</strong>
                    </div>
                </div>
            </div>
            <div class="progress-wrap">
                <div class="progress-label">
                    <span>Path Completion</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="historyProgressFill"></div>
                </div>
            </div>
        </section>

        <section class="unit-grid" id="unitGrid"></section>

        <section class="reset-section">
            <p style="font-weight: 700; color: #23160f;">Start Over?</p>
            <p>Reset your progress for this History pathway.</p>
            <button class="danger-btn" onclick="resetHistoryProgress()">Reset History Progress</button>
        </section>
    </main>

    <script>
        const historyUnits = [
            {
                id: 'sukhothai',
                title: 'Sukhothai Kingdom',
                description: 'Origins of Thai statehood: founding rulers, cultural consolidation, and administrative patterns.',
                points: [
                    'Founded in the 13th century with Pho Khun Si Inthrathit; expanded under King Ramkhamhaeng.',
                    'King Ramkhamhaeng promoted Theravada Buddhism and created the Thai script for state cohesion.',
                    'The kingdom used mandala-style influence over surrounding cities through tributary relations.',
                    'Local governance relied on paternalistic rule with royal patronage to cement loyalty.',
                    'Stone Inscription No. 1 provides insight into administration, economy, and cultural life.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'Which ruler is credited with creating the Thai script?', options: [ { text: 'King Ramkhamhaeng', correct: true }, { text: 'King Taksin', correct: false }, { text: 'King Narai', correct: false } ] },
                    { id: 'q2', prompt: 'Sukhothai extended influence mainly through:', options: [ { text: 'Tributary mandala relationships', correct: true }, { text: 'Overseas colonies', correct: false }, { text: 'Permanent standing armies in each city', correct: false } ] },
                    { id: 'q3', prompt: 'Stone Inscription No. 1 is important because it:', options: [ { text: 'Describes governance and daily life', correct: true }, { text: 'Details European trade treaties', correct: false }, { text: 'Lists Ayutthaya naval battles', correct: false } ] }
                ]
            },
            {
                id: 'ayutthaya',
                title: 'Ayutthaya (Capital City)',
                description: 'Growth of a cosmopolitan capital, warfare, diplomacy, and regional trade networks.',
                points: [
                    'Founded in 1351 and became a regional trading hub connecting China, India, and Europe.',
                    'Maintained mandala-style hierarchy with vassal states and a strong royal court.',
                    'King Narai expanded diplomatic contacts, including missions to France and Persia.',
                    'Laws such as the Palace Law and the Three Seals Code structured court and administration.',
                    'The fall of Ayutthaya in 1767 followed sustained Burmese invasions and internal strain.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'Ayutthaya rose as a major hub because of:', options: [ { text: 'Strategic river location for trade', correct: true }, { text: 'Exclusive focus on agriculture', correct: false }, { text: 'Complete isolation from foreigners', correct: false } ] },
                    { id: 'q2', prompt: 'Which king is known for expansive diplomacy during Ayutthaya?', options: [ { text: 'King Narai', correct: true }, { text: 'King Vajiravudh', correct: false }, { text: 'King Rama III', correct: false } ] },
                    { id: 'q3', prompt: 'Ayutthaya collapsed in 1767 primarily due to:', options: [ { text: 'Burmese invasions and internal strain', correct: true }, { text: 'Atlantic hurricanes', correct: false }, { text: 'A dynastic union with Sukhothai', correct: false } ] }
                ]
            },
            {
                id: 'thonburi-rattanakosin',
                title: 'Thonburi and Rattanakosin Periods (1767-1874)',
                description: 'Reunification after Ayutthaya, founding of Bangkok, and early Chakri consolidation.',
                points: [
                    'King Taksin reunited territories from Thonburi after Ayutthaya fell.',
                    'King Rama I founded Bangkok in 1782, establishing the Chakri dynasty.',
                    'Defensive focus on border stability while rebuilding economy and administration.',
                    'Rama III negotiated early treaties with Western powers, balancing trade and sovereignty.',
                    'Cultural renewal included temple reconstruction and codification of laws.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'Who reunified Siam shortly after Ayutthaya collapsed?', options: [ { text: 'King Taksin', correct: true }, { text: 'King Mongkut', correct: false }, { text: 'King Narai', correct: false } ] },
                    { id: 'q2', prompt: 'Bangkok was established as the capital under:', options: [ { text: 'King Rama I', correct: true }, { text: 'King Rama IV', correct: false }, { text: 'King Rama VII', correct: false } ] },
                    { id: 'q3', prompt: 'Early Rattanakosin diplomacy focused on:', options: [ { text: 'Managing Western trade treaties', correct: true }, { text: 'Joining colonial empires overseas', correct: false }, { text: 'Abandoning maritime trade entirely', correct: false } ] }
                ]
            },
            {
                id: 'modernization-reforms',
                title: 'Administrative Reforms for Modernization',
                description: 'Centralizing reforms that modernized administration, law, and social structures.',
                points: [
                    'King Mongkut and King Chulalongkorn engaged Western advisers to avoid colonization.',
                    'Abolition of slavery and the corvee system reduced hereditary obligations.',
                    'The monthon system reorganized provinces under interior ministries for tighter control.',
                    'Civil service modernization created specialized ministries (finance, justice, education).',
                    'Infrastructure projects (railways, telegraph) connected markets and administrative centers.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'The monthon system primarily aimed to:', options: [ { text: 'Centralize provincial administration', correct: true }, { text: 'Expand slavery', correct: false }, { text: 'Create overseas colonies', correct: false } ] },
                    { id: 'q2', prompt: 'A key social reform in this period was:', options: [ { text: 'Abolition of slavery and corvee labor', correct: true }, { text: 'Mandatory feudal service expansion', correct: false }, { text: 'Outlawing railways', correct: false } ] },
                    { id: 'q3', prompt: 'Modern ministries were built to handle:', options: [ { text: 'Finance, justice, and education', correct: true }, { text: 'Only palace ceremonies', correct: false }, { text: 'Exclusive military rule', correct: false } ] }
                ]
            },
            {
                id: 'revolution-1932',
                title: '1932 Political Revolution',
                description: 'Transition from absolute monarchy to constitutional rule led by Khana Ratsadon.',
                points: [
                    'Khana Ratsadon (People\'s Party) demanded constitutional government and budgetary oversight.',
                    'June 1932 ended absolute monarchy, prompting Thailand’s first constitution.',
                    'Pridi Banomyong and Plaek Phibunsongkhram emerged as key political figures.',
                    'Tensions persisted between royalists, military leaders, and civilian reformers.',
                    'The new system established a National Assembly and opened party politics.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'The 1932 change was driven by:', options: [ { text: 'Khana Ratsadon pushing for a constitution', correct: true }, { text: 'Foreign invasion', correct: false }, { text: 'Demand for absolute monarchy', correct: false } ] },
                    { id: 'q2', prompt: 'Which institution was created after 1932?', options: [ { text: 'National Assembly', correct: true }, { text: 'Supreme hereditary council', correct: false }, { text: 'Foreign protectorate administration', correct: false } ] },
                    { id: 'q3', prompt: 'A central tension after 1932 involved:', options: [ { text: 'Royalists and military-civilian reformers', correct: true }, { text: 'Provinces seceding from Siam', correct: false }, { text: 'Abolition of education', correct: false } ] }
                ]
            },
            {
                id: 'post-1932-politics',
                title: 'Thai Politics After the 1932 Revolution - Present Day',
                description: 'Key political shifts, coups, constitutions, and democratic movements.',
                points: [
                    'Military influence remained strong with recurring coups throughout the 20th century.',
                    'Cold War alignment shaped security policy and aid-driven development.',
                    'The 1997 "People\'s Constitution" expanded rights and strengthened independent bodies.',
                    'Mass movements in 1973, 1992, and 2020 signaled public demands for accountability.',
                    'Recent politics balance electoral competition, constitutional courts, and military roles.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'Thai politics after 1932 often featured:', options: [ { text: 'Recurring military coups', correct: true }, { text: 'No constitutional changes', correct: false }, { text: 'Isolation from global alliances', correct: false } ] },
                    { id: 'q2', prompt: 'The 1997 constitution was notable for:', options: [ { text: 'Expanding civil rights and watchdog agencies', correct: true }, { text: 'Ending elections permanently', correct: false }, { text: 'Reinstating absolute monarchy', correct: false } ] },
                    { id: 'q3', prompt: 'Public protests in 1973, 1992, or 2020 demanded:', options: [ { text: 'More accountability and democracy', correct: true }, { text: 'Higher poll taxes', correct: false }, { text: 'Closing universities', correct: false } ] }
                ]
            },
            {
                id: 'public-administration',
                title: 'Thai Public Administration',
                description: 'Structures, civil service traditions, and decentralization efforts.',
                points: [
                    'A bureaucratic polity placed senior civil servants at the center of policymaking.',
                    'Ministries coordinate national policy; provincial governors represent the center in provinces.',
                    'Local government reforms introduced elected local councils and municipalities.',
                    'Fiscal decentralization efforts aim to expand local service delivery capacity.',
                    'Public administration now balances central oversight with local autonomy and accountability.'
                ],
                formulas: [],
                quiz: [
                    { id: 'q1', prompt: 'Bureaucratic polity in Thailand means:', options: [ { text: 'Civil servants dominate policy decisions', correct: true }, { text: 'All decisions made by private firms', correct: false }, { text: 'No ministries exist', correct: false } ] },
                    { id: 'q2', prompt: 'Provincial governors primarily serve as:', options: [ { text: 'Central government representatives', correct: true }, { text: 'Independent monarchs', correct: false }, { text: 'Foreign diplomats', correct: false } ] },
                    { id: 'q3', prompt: 'Local government reform introduced:', options: [ { text: 'Elected local councils and municipalities', correct: true }, { text: 'Removal of all local services', correct: false }, { text: 'Nationalizing every village enterprise', correct: false } ] }
                ]
            }
        ];

        const storageKey = 'adaptohub_history_units';
        let unitProgress = JSON.parse(localStorage.getItem(storageKey) || '{}');

        function saveProgress() {
            localStorage.setItem(storageKey, JSON.stringify(unitProgress));
        }

        function renderSummary() {
            const completed = historyUnits.filter(u => unitProgress[u.id]?.completed).length;
            const scores = historyUnits.map(u => unitProgress[u.id]?.score).filter(s => typeof s === 'number');
            const avg = scores.length ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const percent = Math.round((completed / historyUnits.length) * 100);

            const unitsCompletedEl = document.getElementById('unitsCompleted');
            const averageScoreEl = document.getElementById('averageScore');
            const progressPercentEl = document.getElementById('progressPercent');
            const progressFillEl = document.getElementById('historyProgressFill');

            if (unitsCompletedEl) unitsCompletedEl.textContent = `${completed} / ${historyUnits.length}`;
            if (averageScoreEl) averageScoreEl.textContent = `${avg}%`;
            if (progressPercentEl) progressPercentEl.textContent = `${percent}%`;
            if (progressFillEl) progressFillEl.style.width = `${percent}%`;
        }

        function formatFormula(formula) {
            return formula
                .replace(/(\w)_([A-Za-z0-9]+)/g, '$1<sub>$2</sub>')
                .replace(/\^(\d+)/g, '<sup>$1</sup>')
                .replace(/([A-Za-z])([0-9]+)/g, '$1<sub>$2</sub>');
        }

        function retakeUnit(unitId) {
            if (confirm('Retake this unit? Your previous score will be cleared.')) {
                delete unitProgress[unitId];
                saveProgress();
                renderSummary();
                renderUnits();
            }
        }

        function resetHistoryProgress() {
            if (confirm('Reset progress for all History units? This cannot be undone.')) {
                localStorage.removeItem(storageKey);
                unitProgress = {};
                renderSummary();
                renderUnits();
                alert('History progress has been reset.');
            }
        }

        function renderUnits() {
            const grid = document.getElementById('unitGrid');
            if (!grid) return;

            grid.innerHTML = '';

            historyUnits.forEach((unit, index) => {
                const prevUnit = historyUnits[index - 1];
                const locked = index > 0 && !(unitProgress[prevUnit.id]?.completed);
                const progress = unitProgress[unit.id] || {};

                const card = document.createElement('article');
                card.className = `unit-card ${locked ? 'locked' : ''}`;

                const statusClass = locked ? 'status-locked' : progress.completed ? 'status-done' : 'status-pending';
                const statusText = locked ? 'Complete the previous unit first' : progress.completed ? `Completed • ${progress.score || 0}%` : 'Quiz ready';

                const lessonList = unit.points.map(point => `<div class="lesson-point">${point}</div>`).join('');
                const formulaList = unit.formulas.map(f => `<span class="formula-badge">${formatFormula(f)}</span>`).join('');

                const questionsHtml = unit.quiz.map(q => `
                    <div class="quiz-question" style="margin-bottom:10px;">
                        <p class="quiz-title">${q.prompt}</p>
                        ${q.options.map(opt => `
                            <label class="quiz-option">
                                <input type="radio" name="${unit.id}-${q.id}" value="${opt.correct ? 'correct' : 'wrong'}" ${locked || progress.completed ? 'disabled' : ''}>
                                <span>${opt.text}</span>
                            </label>
                        `).join('')}
                    </div>
                `).join('');

                const actionButtons = progress.completed
                    ? `<button class="secondary-btn" onclick="retakeUnit('${unit.id}')">Retake Unit</button><span class="quiz-result" id="result-${unit.id}" style="margin-left: 10px;"></span>`
                    : `<button class="primary-btn" onclick="submitQuiz('${unit.id}')" ${locked ? 'disabled' : ''}>Submit quiz</button><span class="quiz-result" id="result-${unit.id}"></span>`;

                card.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-label">Unit ${index + 1}</div>
                        <div class="unit-status ${statusClass}">${statusText}</div>
                    </div>
                    <h3 class="unit-title">${unit.title}</h3>
                    <p class="unit-desc">${unit.description}</p>
                    <div class="lesson-points">${lessonList}</div>
                    <div class="formula-badges">${formulaList}</div>
                    <div class="quiz-block" data-quiz="${unit.id}">
                        <p style="margin:0 0 6px; font-weight:700; color:#23160f;">Quick mastery quiz (3 questions)</p>
                        ${locked ? `<p class="locked-note">Unlock by completing Unit ${index}</p>` : ''}
                        ${questionsHtml}
                        <div class="quiz-actions">${actionButtons}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function submitQuiz(unitId) {
            const unit = historyUnits.find(u => u.id === unitId);
            if (!unit) return;
            if (unitProgress[unitId]?.completed) {
                alert('This unit has already been submitted. Use Retake Unit to try again.');
                return;
            }

            const quizBlock = document.querySelector(`[data-quiz="${unitId}"]`);
            if (!quizBlock) return;

            let answered = 0;
            let correct = 0;

            unit.quiz.forEach(q => {
                const selected = quizBlock.querySelector(`input[name="${unit.id}-${q.id}"]:checked`);
                if (selected) {
                    answered++;
                    if (selected.value === 'correct') correct++;
                }
            });

            if (answered !== unit.quiz.length) {
                alert('Please answer every question before submitting.');
                return;
            }

            const score = Math.round((correct / unit.quiz.length) * 100);
            unitProgress[unitId] = { completed: true, score, timestamp: Date.now() };
            saveProgress();
            renderSummary();
            renderUnits();

            const resultEl = document.getElementById(`result-${unitId}`);
            if (resultEl) {
                resultEl.textContent = score >= 70 ? `Great work: ${score}%` : `Keep reviewing: ${score}%`;
                resultEl.className = `quiz-result ${score >= 70 ? 'result-pass' : 'result-fail'}`;
            }

            if (window.FeatureIntegration && window.FeatureIntegration.onQuizComplete) {
                window.FeatureIntegration.onQuizComplete(unitId, score, 'history');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeUser();
            renderSummary();
            renderUnits();
        });
    </script>
</body>
</html>
